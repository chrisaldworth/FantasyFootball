#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if there are any staged files
if [ -z "$STAGED_FILES" ]; then
  echo "No files staged for commit"
  exit 0
fi

# Determine which tests to run based on changed files
RUN_FRONTEND_TESTS=false
RUN_BACKEND_TESTS=false
RUN_IOS_TESTS=false

for FILE in $STAGED_FILES; do
  if [[ "$FILE" == frontend/* ]] || [[ "$FILE" == frontend/src/** ]]; then
    RUN_FRONTEND_TESTS=true
  fi
  if [[ "$FILE" == backend/* ]] || [[ "$FILE" == backend/app/** ]]; then
    RUN_BACKEND_TESTS=true
  fi
  if [[ "$FILE" == frontend/ios/** ]]; then
    RUN_IOS_TESTS=true
  fi
done

# If no specific files match, run all tests
if [ "$RUN_FRONTEND_TESTS" = false ] && [ "$RUN_BACKEND_TESTS" = false ] && [ "$RUN_IOS_TESTS" = false ]; then
  RUN_FRONTEND_TESTS=true
  RUN_BACKEND_TESTS=true
fi

FAILED=0

# Run frontend tests
if [ "$RUN_FRONTEND_TESTS" = true ]; then
  echo ""
  echo "üß™ Running frontend tests..."
  cd frontend || exit 1
  
  # Check if node_modules exists
  if [ ! -d "node_modules" ]; then
    echo "‚ö†Ô∏è  node_modules not found. Installing dependencies..."
    npm install --silent
  fi
  
  # Run linting first (faster)
  echo "üìù Running linter..."
  if npm run lint -- --max-warnings=0 > /tmp/frontend_lint.log 2>&1; then
    echo "‚úÖ Linting passed"
  else
    echo "‚ùå Linting failed. Please fix errors:"
    cat /tmp/frontend_lint.log | tail -20
    FAILED=1
  fi
  
  # Run unit tests
  echo "üß™ Running unit tests..."
  if npm test -- --passWithNoTests --silent --bail > /tmp/frontend_tests.log 2>&1; then
    echo "‚úÖ Frontend tests passed"
  else
    echo "‚ùå Frontend tests failed:"
    cat /tmp/frontend_tests.log | tail -30
    FAILED=1
  fi
  
  cd ..
fi

# Run backend tests (if backend files changed)
if [ "$RUN_BACKEND_TESTS" = true ]; then
  echo ""
  echo "üß™ Running backend tests..."
  cd backend || exit 1
  
  # Check if virtual environment exists
  if [ ! -d "venv" ]; then
    echo "‚ö†Ô∏è  Virtual environment not found. Skipping backend tests."
    echo "   To set up: python -m venv venv && source venv/bin/activate && pip install -r requirements.txt"
  else
    source venv/bin/activate
    
    # Run backend tests if pytest is available
    if command -v pytest &> /dev/null; then
      if pytest tests/ -v --tb=short > /tmp/backend_tests.log 2>&1; then
        echo "‚úÖ Backend tests passed"
      else
        echo "‚ùå Backend tests failed:"
        cat /tmp/backend_tests.log | tail -30
        FAILED=1
      fi
    else
      echo "‚ö†Ô∏è  pytest not found. Skipping backend tests."
    fi
    
    deactivate
  fi
  
  cd ..
fi

# Summary
echo ""
if [ $FAILED -eq 0 ]; then
  echo "‚úÖ All pre-commit checks passed!"
  exit 0
else
  echo "‚ùå Pre-commit checks failed. Please fix errors before committing."
  echo ""
  echo "To skip pre-commit hooks (not recommended):"
  echo "  git commit --no-verify"
  exit 1
fi
