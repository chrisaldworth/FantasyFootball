name: Automated Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Start backend
        run: |
          cd backend
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8080 &
          sleep 10
          # Verify backend is running
          curl -f http://localhost:8080/health || exit 1
      
      - name: Run backend tests
        run: |
          chmod +x scripts/test_agent.sh
          ./scripts/test_agent.sh backend

  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run frontend build test
        run: |
          cd frontend
          npm run build
      
      - name: Run frontend tests
        run: |
          chmod +x scripts/test_agent.sh
          ./scripts/test_agent.sh frontend || (echo "Frontend build failed, checking logs..." && cat /tmp/frontend_build.log 2>/dev/null || echo "No log file found" && exit 1)

  ios-tests:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
      
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
      
      - name: Sync Capacitor
        run: |
          cd frontend
          export LANG=en_US.UTF-8
          npx cap sync ios
      
      - name: Install pods
        run: |
          cd frontend/ios/App
          export LANG=en_US.UTF-8
          pod install
      
      - name: List available simulators
        run: |
          xcrun simctl list devices available | grep -i "iphone" | head -5
      
      - name: Build and test iOS app
        run: |
          cd frontend/ios/App
          export DEVELOPER_DIR=$(xcode-select -p)
          export LANG=en_US.UTF-8
          # Try to find an available iPhone simulator, fallback to iPhone 15 Pro
          SIMULATOR_NAME=$(xcrun simctl list devices available | grep -i "iphone" | head -1 | awk -F'[()]' '{print $2}' | xargs || echo "iPhone 15 Pro")
          echo "Using simulator: $SIMULATOR_NAME"
          # Verify workspace exists
          if [ ! -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "Error: Xcode workspace not found"
            ls -la
            exit 1
          fi
          # Build and test with better error handling
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -destination "platform=iOS Simulator,name=$SIMULATOR_NAME" \
            -configuration Debug \
            -allowProvisioningUpdates \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            clean build test 2>&1 | tee /tmp/xcodebuild.log || (echo "Build failed, showing logs:" && cat /tmp/xcodebuild.log && exit 1)

